# 使用手册

完整的 Claude Code Everywhere 使用指南。

## 目录

- [快速开始](#快速开始)
- [AI 智能交互](#ai-智能交互)
- [工作目录管理](#工作目录管理)
- [预览功能](#预览功能)
- [聊天历史](#聊天历史)
- [系统管理](#系统管理)
- [数据库](#数据库)
- [常见问题](#常见问题)

## 快速开始

### 第一次使用

1. **查看帮助**

   ```
   @机器人 帮助
   ```

2. **添加工作目录**

   ```
   @机器人 添加目录 blog /path/to/blog
   ```

3. **开始使用**

   ```
   @机器人 帮我检查代码
   ```

### 核心概念

**AI 驱动** - 使用自然语言直接描述需求，AI 自动理解并执行

**工作目录** - 配置常用项目目录，使用别名快速切换

**智能确认** - 危险操作或参数不足时，AI 会请求确认

## AI 智能交互

### 基本使用

直接用自然语言描述需求，无需记忆命令：

```
@机器人 帮我检查代码
@机器人 优化性能
@机器人 添加登录功能
@机器人 列出所有目录
@机器人 启动 blog 的预览
```

### 指定工作目录

**方式 1：在消息中指定**

```
@机器人 在 blog 项目中优化性能
@机器人 帮我在 api 项目里添加用户认证
```

**方式 2：使用默认目录**

```
@机器人 把 blog 设为默认目录
@机器人 帮我检查代码  # 自动在 blog 目录执行
```

### 智能确认机制

当 AI 需要更多信息或操作比较危险时，会请求确认：

**示例 1：参数不足**

```
用户: @机器人 添加一个目录
AI:   请提供以下信息：
      - 目录别名（如：blog）
      - 目录路径（如：/path/to/blog）

      示例：添加目录 blog /path/to/blog

用户: @机器人 添加目录 blog /Users/me/blog
AI:   ✅ 已添加工作目录
```

**示例 2：危险操作**

```
用户: @机器人 删除 test 目录
AI:   ⚠️ 确认要删除目录 'test' 吗？此操作不可恢复。

用户: 确认
AI:   ✅ 已删除工作目录 "test"
```

## 工作目录管理

### 添加目录

**基础添加**

```
@机器人 添加目录 blog /Users/me/blog
```

**带描述**

```
@机器人 添加目录 blog /Users/me/blog 描述是我的个人博客
```

**启用预览**

```
@机器人 添加目录 blog /Users/me/blog 启用预览 启动命令是 npm run dev
```

**设为默认**

```
@机器人 添加目录 blog /Users/me/blog 并设为默认
```

### 查看目录

**列出所有目录**

```
@机器人 列出所有目录
@机器人 查看目录列表
@机器人 有哪些工作目录
```

**查看详情**

```
@机器人 查看 blog 的详情
@机器人 blog 目录的信息
```

### 修改目录

**更新描述**

```
@机器人 更新 blog 的描述为技术博客
```

**启用/禁用预览**

```
@机器人 给 blog 启用预览
@机器人 禁用 api 的预览
```

**更新启动命令**

```
@机器人 更新 blog 的启动命令为 npm run dev
```

### 删除目录

```
@机器人 删除 old-project 目录
@机器人 移除 test 目录
```

**注意**：只删除配置，不删除实际文件。

### 设置默认目录

```
@机器人 把 blog 设为默认目录
@机器人 将 api 设置为默认
```

## 预览功能

### 启动预览

**手动启动**

```
@机器人 启动 blog 的预览
@机器人 预览 web 项目
```

**自动启动**

当工作目录启用预览功能后，任务执行成功会自动启动预览。

### 查看状态

```
@机器人 查看预览状态
@机器人 预览服务的状态
@机器人 blog 的预览状态
```

**输出示例**：

```
📊 预览服务状态

**blog**
端口: 3000
URL: https://random-url.trycloudflare.com
进程 PID: 12345
Tunnel PID: 12346
启动时间: 2024-01-20 15:30:00
```

### 停止预览

**停止单个**

```
@机器人 停止 blog 的预览
```

**停止所有**

```
@机器人 停止所有预览
```

### 配置要求

需要安装 [cloudflared](https://github.com/cloudflare/cloudflared)。详见 [PREVIEW_SETUP.md](PREVIEW_SETUP.md)。

### 适用场景

- **前端项目**：React、Vue、Next.js
- **后端 API**：Node.js、Python、Go
- **全栈应用**：实时预览开发效果
- **移动预览**：通过公网 URL 在手机上查看

## 聊天历史

### 查看历史

```
@机器人 查看 blog 的聊天历史
@机器人 看看 api 项目的对话记录
@机器人 blog 最近20条聊天记录
```

**输出示例**：

```
📝 "blog" 聊天历史（最近 10 条）

**[2024-01-20 15:30:00]**
👤 用户: 帮我优化性能
🤖 助手: 我已经分析了您的代码，发现以下性能问题...

**[2024-01-20 14:15:00]**
👤 用户: 添加登录功能
🤖 助手: 我已经为您添加了登录功能...
```

### 清空历史

```
@机器人 清空 blog 的历史
@机器人 删除 api 的聊天记录
```

## 系统管理

### 系统信息

```
@机器人 系统信息
@机器人 版本信息
```

**输出示例**：

```
ℹ️ 系统信息

**版本**: 1.0.0
**Node.js**: v20.10.0
**平台**: darwin
**架构**: arm64
```

### 健康检查

```
@机器人 健康检查
@机器人 服务状态
```

**输出示例**：

```
💚 系统健康检查

**状态**: healthy
**运行时间**: 120 分钟
**内存使用**: 45 MB / 128 MB
```

## 数据库

### 位置

**默认位置**：`data/data.db`

**自定义位置**（通过 `.env`）：

```bash
DB_PATH=/custom/path/data.db
```

### 表结构

#### working_directories

存储工作目录配置

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| alias | TEXT | 目录别名（唯一） |
| path | TEXT | 完整路径 |
| is_default | INTEGER | 是否默认（0/1） |
| preview_enabled | INTEGER | 是否启用预览（0/1） |
| start_cmd | TEXT | 启动命令 |
| preview_port | INTEGER | 预览端口 |
| description | TEXT | 描述 |
| created_at | INTEGER | 创建时间戳 |
| updated_at | INTEGER | 更新时间戳 |

#### chat_conversations

存储聊天历史

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| alias | TEXT | 目录别名 |
| user_message | TEXT | 用户消息 |
| assistant_message | TEXT | AI 回复 |
| created_at | INTEGER | 时间戳 |

#### preview_services

存储运行中的预览服务

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| alias | TEXT | 目录别名（唯一） |
| pid | INTEGER | 项目进程 PID |
| tunnel_pid | INTEGER | Tunnel 进程 PID |
| port | INTEGER | 端口 |
| tunnel_url | TEXT | 公网 URL |
| started_at | INTEGER | 启动时间戳 |

### 管理

**查看数据**：

```bash
sqlite3 data/data.db
```

```sql
-- 查看所有目录
SELECT * FROM working_directories;

-- 查看聊天历史
SELECT * FROM chat_conversations WHERE alias = 'blog' ORDER BY created_at DESC LIMIT 10;

-- 查看运行中的预览
SELECT * FROM preview_services;
```

**备份**：

```bash
cp data/data.db data/data.db.backup
```

## 常见问题

### 使用相关

**Q: 必须记住命令格式吗？**

A: 不需要。直接用自然语言描述需求，AI 会自动理解。

**Q: 如何指定在某个项目中执行任务？**

A: 三种方式：
1. 在消息中指定："在 blog 项目中优化性能"
2. 设为默认目录后直接说任务："帮我检查代码"
3. 使用传统格式（仍支持）："[dir:blog] 优化性能"

**Q: AI 识别错误怎么办？**

A: 如果 AI 误解了意图，会请求确认。回复"取消"即可。也可以更详细地描述需求。

### 目录相关

**Q: 删除目录配置会删除文件吗？**

A: 不会。只删除数据库配置，不影响实际文件。

**Q: 可以配置多少个目录？**

A: 没有限制，可以配置任意数量。

**Q: 别名可以修改吗？**

A: 不能直接修改。需要删除后重新添加。

### 预览相关

**Q: 预览启动失败怎么办？**

A: 检查：
1. cloudflared 是否已安装
2. 启动命令是否正确
3. 端口是否被占用
4. 查看控制台日志

**Q: 预览 URL 是永久的吗？**

A: 不是。每次启动生成新的临时 URL，只适合开发预览。

**Q: 预览 URL 安全吗？**

A: URL 是公开的，任何人都可以访问。不要暴露敏感信息。

### 安全相关

**Q: 配置 ALLOWED_ROOT_DIR 后还能使用完整路径吗？**

A: 不能。这是安全限制，配置后只能使用相对路径。

**Q: AI 会执行危险操作吗？**

A: 删除、清空等危险操作会自动请求确认，确保安全。

### 性能相关

**Q: 可以同时处理多个任务吗？**

A: 不可以。同一时间只能处理一个任务，避免冲突。

**Q: 聊天历史会影响性能吗？**

A: 不会。历史记录存储在数据库中，不影响运行性能。可以定期清理不需要的历史。

## 相关文档

- [README.md](../README.md) - 项目介绍和快速开始
- [SECURITY.md](SECURITY.md) - 安全配置指南
- [PREVIEW_SETUP.md](PREVIEW_SETUP.md) - 预览功能配置
- [CLAUDE.md](../.claude/CLAUDE.md) - 开发者指南
